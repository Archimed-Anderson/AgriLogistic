version: '3.8'

services:
  # --- INFRASTRUCTURE CORE ---
  postgres:
    image: postgis/postgis:15-3.3-alpine
    container_name: agri-postgres
    ports: ["5432:5432"]
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: AgriLogistic_db_2026
      POSTGRES_DB: agrilogistic
    volumes: ["postgres_data:/var/lib/postgresql/data"]
    networks: ["agri-mesh"]

  redis:
    image: redis:7-alpine
    container_name: agri-redis
    command: redis-server --requirepass redis_secure_2026
    ports: ["6379:6379"]
    networks: ["agri-mesh"]

  # --- AI STACK ---
  qdrant:
    image: qdrant/qdrant:latest
    container_name: agri-qdrant
    ports: ["6333:6333"]
    volumes: ["qdrant_data:/qdrant/storage"]
    networks: ["agri-mesh"]

  ollama:
    image: ollama/ollama:latest
    container_name: agri-ollama
    ports: ["11434:11434"]
    volumes: ["ollama_data:/root/.ollama"]
    networks: ["agri-mesh"]

  # --- IOT & EVENT BUS ---
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: agri-mqtt
    ports: ["1883:1883", "9001:9001"]
    volumes: ["./services/logistics/coldchain-service/mosquitto/config:/mosquitto/config"]
    networks: ["agri-mesh"]

  influxdb:
    image: influxdb:2
    container_name: agri-influx
    ports: ["8086:8086"]
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=AgriLogistic_secure_2026
      - DOCKER_INFLUXDB_INIT_ORG=agrilogistic
      - DOCKER_INFLUXDB_INIT_BUCKET=coldchain
    volumes: ["influx_data:/var/lib/influxdb2"]
    networks: ["agri-mesh"]

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: agri-kafka
    ports: ["9092:9092"]
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@agri-kafka:9093'
      KAFKA_LISTENERS: 'PLAINTEXT://:9092,CONTROLLER://:9093'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://localhost:9092'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    networks: ["agri-mesh"]

  # --- MICROSERVICES ---
  vision-service:
    build: ./services/ai-service/vision-service
    container_name: agri-vision
    ports: ["3009:3009"]
    environment:
      - OLLAMA_HOST=http://ollama:11434
    depends_on: ["ollama"]
    networks: ["agri-mesh"]

  insurance-service:
    build: ./services/intelligence/insurance-service
    container_name: agri-insurance
    ports: ["3010:3010"]
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - WEATHER_SERVICE_URL=http://vision-service:3009
    depends_on: ["vision-service"]
    networks: ["agri-mesh"]

networks:
  agri-mesh:
    driver: bridge

volumes:
  postgres_data:
  qdrant_data:
  ollama_data:
  influx_data: