.PHONY: help validate diff sync reload backup test health metrics test-auth test-rate-limit logs clean

# Configuration
KONG_ADMIN_URL := http://localhost:8001
KONG_PROXY_URL := http://localhost:8000
KONG_CONFIG := /kong/kong.yml

# Colors
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m

help: ## Afficher l'aide
	@echo "$(BLUE)Kong DB-less Management Commands:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-18s$(NC) %s\n", $$1, $$2}'

validate: ## Valider la configuration YAML
	@echo "$(BLUE)üîç Validation de kong.yml...$(NC)"
	@docker exec kong-deck deck validate --state $(KONG_CONFIG) || echo "$(YELLOW)‚ö†Ô∏è  Kong Deck pas encore d√©marr√©$(NC)"
	@echo "$(GREEN)‚úÖ Validation via Kong...$(NC)"
	@docker run --rm -v $$(pwd)/kong:/kong kong:3.4 kong config parse /kong/kong.yml

diff: ## Afficher les diff√©rences avec la config actuelle
	@echo "$(BLUE)üìä Diff√©rences entre fichier et Kong running:$(NC)"
	@docker exec kong-deck deck diff --state $(KONG_CONFIG) --kong-addr $(KONG_ADMIN_URL) || echo "$(YELLOW)‚ö†Ô∏è  Deck ou Kong pas d√©marr√©$(NC)"

sync: validate ## Synchroniser la configuration avec Kong
	@echo "$(BLUE)üîÑ Synchronisation de la configuration...$(NC)"
	@docker exec kong-deck deck sync --state $(KONG_CONFIG) --kong-addr $(KONG_ADMIN_URL)
	@echo "$(GREEN)‚úÖ Configuration synchronis√©e!$(NC)"

reload: sync ## Alias pour sync
	@echo "$(GREEN)‚ôªÔ∏è  Kong configuration recharg√©e!$(NC)"

backup: ## Sauvegarder la configuration actuelle de Kong
	@echo "$(BLUE)üíæ Backup de la configuration...$(NC)"
	@docker exec kong-deck deck dump --output-file /kong/kong.backup.$$(date +%Y%m%d_%H%M%S).yml --kong-addr $(KONG_ADMIN_URL)
	@echo "$(GREEN)‚úÖ Backup cr√©√©!$(NC)"

test: ## Tester les endpoints Kong
	@echo "$(BLUE)üß™ Tests des endpoints...$(NC)"
	@echo "\n$(YELLOW)üìç Health Check:$(NC)"
	@curl -s $(KONG_ADMIN_URL)/status | jq '.database.reachable' || echo "null (DB-less mode)"
	@echo "\n$(YELLOW)üìç Services:$(NC)"
	@curl -s $(KONG_ADMIN_URL)/services | jq '.data[].name' || echo "Erreur"
	@echo "\n$(YELLOW)üìç Routes:$(NC)"
	@curl -s $(KONG_ADMIN_URL)/routes | jq '.data[].name' || echo "Erreur"
	@echo "\n$(YELLOW)üìç Plugins:$(NC)"
	@curl -s $(KONG_ADMIN_URL)/plugins | jq '.data[].name' || echo "Erreur"
	@echo "\n$(GREEN)‚úÖ Tests termin√©s!$(NC)"

health: ## V√©rifier la sant√© de Kong
	@echo "$(BLUE)üè• Kong Health Check:$(NC)"
	@curl -s $(KONG_ADMIN_URL)/status | jq '.'

metrics: ## Afficher les m√©triques Prometheus
	@echo "$(BLUE)üìä M√©triques Prometheus:$(NC)"
	@curl -s $(KONG_PROXY_URL)/metrics | head -n 50

test-auth: ## Tester l'authentification JWT
	@echo "$(BLUE)üîê Test JWT Authentication:$(NC)"
	@echo "\n$(YELLOW)1Ô∏è‚É£  Sans token (devrait retourner 401):$(NC)"
	@curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" $(KONG_PROXY_URL)/api/v1/products
	@echo "\n$(YELLOW)2Ô∏è‚É£  Avec token JWT:$(NC)"
	@echo "   G√©n√©rer via: curl -X POST $(KONG_PROXY_URL)/api/v1/auth/login"

test-rate-limit: ## Tester le rate limiting
	@echo "$(BLUE)‚è±Ô∏è  Test Rate Limiting:$(NC)"
	@for i in $$(seq 1 105); do \
		STATUS=$$(curl -s -o /dev/null -w "%{http_code}" $(KONG_PROXY_URL)/api/v1/auth/health || echo "000"); \
		if [ "$$STATUS" = "429" ]; then \
			echo "$(GREEN)‚úÖ Rate limit d√©clench√© apr√®s $$i requ√™tes$(NC)"; \
			break; \
		fi; \
		if [ $$i -eq 105 ]; then \
			echo "$(YELLOW)‚ö†Ô∏è  Rate limit non atteint apr√®s 105 requ√™tes$(NC)"; \
		fi; \
	done

logs: ## Voir les logs Kong
	@docker logs -f kong-gateway

install-deck: ## Installer Kong Deck CLI localement
	@echo "$(BLUE)üì• Installation de Kong Deck...$(NC)"
	@echo "$(YELLOW)Visitez: https://docs.konghq.com/deck/latest/installation/$(NC)"

clean: ## Nettoyer les backups anciens (>30 jours)
	@find kong -name "kong.backup.*.yml" -mtime +30 -delete 2>/dev/null || true
	@echo "$(GREEN)üßπ Anciens backups supprim√©s$(NC)"

status: ## Afficher le statut complet
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë   Kong Gateway Status$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(YELLOW)üê≥ Docker Containers:$(NC)"
	@docker ps --filter "name=kong" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "$(YELLOW)üìä Kong Info:$(NC)"
	@curl -s $(KONG_ADMIN_URL)/ | jq '{version:.version, hostname:.hostname, timers:.timers}'
	@echo ""
	@echo "$(YELLOW)üìà Kong Stats:$(NC)"
	@curl -s $(KONG_ADMIN_URL)/status | jq '{server:.server, database:.database}'

quick-test: ## Test rapide (health + services)
	@echo "$(BLUE)‚ö° Quick Test$(NC)"
	@curl -s $(KONG_ADMIN_URL)/status > /dev/null && echo "$(GREEN)‚úÖ Kong Admin API$(NC)" || echo "$(RED)‚ùå Kong Admin API$(NC)"
	@curl -s $(KONG_ADMIN_URL)/services | jq -e '.data | length > 0' > /dev/null && echo "$(GREEN)‚úÖ Services configur√©s$(NC)" || echo "$(YELLOW)‚ö†Ô∏è  Aucun service$(NC)"
	@curl -s $(KONG_PROXY_URL)/metrics > /dev/null && echo "$(GREEN)‚úÖ M√©triques disponibles$(NC)" || echo "$(YELLOW)‚ö†Ô∏è  M√©triques indisponibles$(NC)"
