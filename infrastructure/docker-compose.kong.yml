version: '3.9'

# ============================================================
# Kong API Gateway Stack for AgroLogistic 2.0
# Production-ready Docker Compose configuration
# ============================================================

networks:
  agrologistic-network:
    external: true

volumes:
  kong-postgres-data:
    name: agrologistic-kong-db
  konga-postgres-data:
    name: agrologistic-konga-db
  kong-logs:
    name: agrologistic-kong-logs
  prometheus-data:
    name: agrologistic-prometheus-data
  grafana-data:
    name: agrologistic-grafana-data

services:
  # ============================================================
  # PostgreSQL Database for Kong
  # ============================================================
  kong-database:
    image: postgres:14-alpine
    container_name: agrologistic-kong-db
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      POSTGRES_USER: ${KONG_PG_USER:-kong}
      POSTGRES_DB: ${KONG_PG_DATABASE:-kong}
      # Même valeur par défaut que kong-bootstrap/kong-gateway pour éviter "authentication exchange unsuccessful"
      POSTGRES_PASSWORD: ${KONG_PG_PASSWORD:-kong_secure_2026}
    volumes:
      - kong-postgres-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"  # Exposition externe (optionnel) pour backup
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Kong Database Bootstrap (one-time migration)
  # ============================================================
  kong-bootstrap:
    image: kong:3.5
    container_name: agrologistic-kong-bootstrap
    command: >
      sh -c "
        echo 'Waiting for PostgreSQL...';
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if kong migrations bootstrap; then break; fi;
          echo \"Attempt $$i/10 failed, retrying in 5s...\";
          sleep 5;
        done &&
        if grep -q '__RSA_PUBLIC_KEY__' /usr/local/kong/declarative/kong.yml; then
          echo 'ERROR: RS256 public key placeholder not replaced.' >&2;
          exit 1;
        fi &&
        kong config db_import /usr/local/kong/declarative/kong.yml > /tmp/import.log 2>&1; r=$$?; cat /tmp/import.log; grep -q 'UNIQUE violation' /tmp/import.log && exit 0; exit $$r
      "
    networks:
      - agrologistic-network
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: ${KONG_PG_USER:-kong}
      # Même valeur que kong-database (défaut kong_secure_2026) pour éviter authentication exchange unsuccessful
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:-kong_secure_2026}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong}
    volumes:
      - ./kong/kong.yml:/usr/local/kong/declarative/kong.yml:ro
    depends_on:
      kong-database:
        condition: service_healthy
    restart: "no"

  # ============================================================
  # Kong API Gateway
  # ============================================================
  kong-gateway:
    image: kong:3.5
    container_name: agrologistic-kong-gateway
    restart: unless-stopped
    command: ["kong", "start", "-c", "/usr/local/kong/kong.conf"]
    networks:
      - agrologistic-network
    environment:
      # Database
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: ${KONG_PG_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:-kong_secure_2026}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong}
      
      # Proxy configuration
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl http2
      
      # Admin API
      # Security: bind Admin API on container, but expose only on localhost via ports mapping.
      KONG_ADMIN_LISTEN: 0.0.0.0:8001

      # Status API (Prometheus `/metrics` is exposed here)
      KONG_STATUS_LISTEN: 0.0.0.0:8100
      
      # Plugins
      KONG_PLUGINS: bundled,jwt,rate-limiting,cors,request-transformer,response-transformer,prometheus,file-log,http-log,ip-restriction,request-size-limiting,proxy-cache,acl,correlation-id,zipkin,key-auth
      
      # DNS resolver (Docker internal DNS for service discovery)
      KONG_DNS_RESOLVER: 127.0.0.11
      
      # Performance
      KONG_NGINX_WORKER_PROCESSES: "auto"
      KONG_MEM_CACHE_SIZE: 128m
      
      # Security
      KONG_TRUSTED_IPS: 0.0.0.0/0,::/0
    volumes:
      - ./kong/kong.conf:/usr/local/kong/kong.conf:ro
      - ./kong/kong.yml:/usr/local/kong/declarative/kong.yml:ro
      - kong-logs:/var/log/kong
    ports:
      - "8000:8000"   # Proxy HTTP
      - "8443:8443"   # Proxy HTTPS
      - "127.0.0.1:8001:8001"   # Admin API (localhost only)
      - "8100:8100"   # Status API /metrics
    depends_on:
      kong-bootstrap:
        condition: service_completed_successfully
      kong-database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ============================================================
  # PostgreSQL Database for Konga (separate DB for compatibility)
  # ============================================================
  konga-database:
    image: postgres:11-alpine
    container_name: agrologistic-konga-db
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      # Konga connects using these credentials
      POSTGRES_USER: ${KONG_PG_USER:-kong}
      POSTGRES_DB: konga
      POSTGRES_PASSWORD: ${KONG_PG_PASSWORD:-kong_secure_2026}
    volumes:
      - konga-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong -d konga"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ============================================================
  # Konga - Kong Admin UI
  # ============================================================
  # One-shot DB schema preparation (required by Konga)
  konga-prepare:
    image: pantsel/konga:0.14.9
    container_name: agrologistic-konga-prepare
    restart: "no"
    networks:
      - agrologistic-network
    command: >
      -c prepare
      -a postgres
      -u postgresql://${KONG_PG_USER:-kong}:${KONG_PG_PASSWORD:-kong_secure_2026}@konga-database:5432/konga
    depends_on:
      konga-database:
        condition: service_healthy

  konga:
    image: pantsel/konga:0.14.9
    container_name: agrologistic-konga
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      DB_ADAPTER: postgres
      DB_HOST: konga-database
      DB_PORT: 5432
      DB_USER: ${KONG_PG_USER:-kong}
      DB_PASSWORD: ${KONG_PG_PASSWORD:-kong_secure_2026}
      DB_DATABASE: konga
      # IMPORTANT:
      # Konga uses Waterline migrations. In `production` it defaults to a safe
      # strategy and expects tables to exist. We run it in `development` for
      # auto-creation of schema (first boot). For hard-prod, switch back and
      # pre-provision the schema.
      NODE_ENV: development
      TOKEN_SECRET: ${KONGA_TOKEN_SECRET:-konga_secret_change_me}
      KONGA_HOOK_TIMEOUT: 120000
    ports:
      - "1337:1337"
    depends_on:
      konga-database:
        condition: service_healthy
      konga-prepare:
        condition: service_completed_successfully
      kong-gateway:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:1337', r => process.exit(r.statusCode < 500 ? 0 : 1)).on('error', () => process.exit(1));",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # ============================================================
  # Prometheus (Optional - for monitoring)
  # ============================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: agrologistic-prometheus
    restart: unless-stopped
    networks:
      - agrologistic-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      - kong-gateway
    profiles:
      - monitoring

  # ============================================================
  # Grafana (Optional - for dashboards)
  # ============================================================
  grafana:
    image: grafana/grafana:latest
    container_name: agrologistic-grafana
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/prometheus.yml:ro
      - ./monitoring/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/kong.yml:ro
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
    profiles:
      - monitoring

  # ============================================================
  # Jaeger (Optional - tracing via Zipkin plugin)
  # ============================================================
  jaeger:
    image: jaegertracing/all-in-one:1.51
    container_name: agrologistic-jaeger
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
    ports:
      - "16686:16686"  # Jaeger UI
      - "9411:9411"    # Zipkin collector (for Kong zipkin plugin)
    profiles:
      - tracing

