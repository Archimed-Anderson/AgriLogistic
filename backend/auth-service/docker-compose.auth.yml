version: "3.9"

networks:
  agrologistic-network:
    external: true

volumes:
  auth-postgres-data:
    name: agrologistic-auth-postgres-data
  auth-redis-data:
    name: agrologistic-auth-redis-data

services:
  auth-postgres:
    image: postgres:14-alpine
    container_name: agrologistic-auth-postgres
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      POSTGRES_DB: ${AUTH_PG_DATABASE:-agrologistic_auth}
      POSTGRES_USER: ${AUTH_PG_USER:-auth}
      POSTGRES_PASSWORD: ${AUTH_PG_PASSWORD:?AUTH_PG_PASSWORD is required}
    volumes:
      - auth-postgres-data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_PG_USER:-auth} -d ${AUTH_PG_DATABASE:-agrologistic_auth}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  auth-redis:
    image: redis:7-alpine
    container_name: agrologistic-auth-redis
    restart: unless-stopped
    networks:
      - agrologistic-network
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - auth-redis-data:/data
    ports:
      - "127.0.0.1:6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

  auth-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: agrologistic/auth-service:latest
    container_name: agrologistic-auth-service
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      # App
      ENV: ${ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PYTHONPATH: /app

      # DB / Redis
      # Provide defaults so migrations/tests can run with only AUTH_PG_PASSWORD set.
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://${AUTH_PG_USER:-auth}:${AUTH_PG_PASSWORD}@auth-postgres:5432/${AUTH_PG_DATABASE:-agrologistic_auth}}
      REDIS_URL: ${REDIS_URL:-redis://auth-redis:6379/0}

      # JWT / OIDC
      OIDC_ISSUER: ${OIDC_ISSUER:-http://localhost:8000}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-RS256}
      JWT_KID: ${JWT_KID:-web-app-jwt-key}
      JWT_PRIVATE_KEY_PATH: ${JWT_PRIVATE_KEY_PATH:-/keys/jwt-private.pem}
      JWT_PUBLIC_KEY_PATH: ${JWT_PUBLIC_KEY_PATH:-/keys/jwt-public.pem}
      ACCESS_TOKEN_EXPIRE_SECONDS: ${ACCESS_TOKEN_EXPIRE_SECONDS:-900}
      REFRESH_TOKEN_EXPIRE_SECONDS: ${REFRESH_TOKEN_EXPIRE_SECONDS:-604800}

      # Social providers (optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      OAUTH_SESSION_SECRET: ${OAUTH_SESSION_SECRET:-change_me}

      # Security
      MAX_LOGIN_ATTEMPTS: ${MAX_LOGIN_ATTEMPTS:-5}
      LOCKOUT_DURATION_MINUTES: ${LOCKOUT_DURATION_MINUTES:-30}
      LOGIN_RATE_LIMIT_MAX: ${LOGIN_RATE_LIMIT_MAX:-5}
      LOGIN_RATE_LIMIT_WINDOW_SECONDS: ${LOGIN_RATE_LIMIT_WINDOW_SECONDS:-900}

      # First-party OAuth client bootstrap (required)
      FIRST_PARTY_CLIENT_ID: ${FIRST_PARTY_CLIENT_ID:-agrologistic-web-app}
      FIRST_PARTY_CLIENT_SECRET: ${FIRST_PARTY_CLIENT_SECRET:-change_me}
      FIRST_PARTY_CLIENT_NAME: ${FIRST_PARTY_CLIENT_NAME:-AgroLogistic Web App}
      FIRST_PARTY_REDIRECT_URIS: ${FIRST_PARTY_REDIRECT_URIS:-http://localhost:3000/api/auth/callback}

    volumes:
      # Reuse the same RSA keys used by Kong setup (RS256 end-to-end)
      - ../../infrastructure/kong/keys:/keys:ro
    ports:
      # Expose locally for debugging; Kong reaches it via Docker network.
      - "127.0.0.1:8005:8001"
    depends_on:
      auth-postgres:
        condition: service_healthy
      auth-redis:
        condition: service_healthy
