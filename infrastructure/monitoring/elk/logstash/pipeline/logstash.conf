input {
  beats {
    port => 5044
  }
  
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  # Parse JSON logs from Docker containers
  if [container][name] =~ /agrodeep/ {
    json {
      source => "message"
      target => "log"
      skip_on_invalid_json => true
    }

    mutate {
      add_field => {
        "service" => "%{[container][name]}"
        "environment" => "production"
      }
    }

    # Parse timestamp
    if [log][timestamp] {
      date {
        match => ["[log][timestamp]", "ISO8601"]
        target => "@timestamp"
      }
    }

    # Extract log level
    if [log][level] {
      mutate {
        add_field => { "log_level" => "%{[log][level]}" }
      }
    }

    # Tag errors for special handling
    if [log][level] in ["error", "fatal", "ERROR", "FATAL"] {
      mutate {
        add_tag => ["error"]
      }
    }

    # Extract request information
    if [log][req] {
      mutate {
        add_field => {
          "request_method" => "%{[log][req][method]}"
          "request_url" => "%{[log][req][url]}"
          "response_status" => "%{[log][res][statusCode]}"
          "response_time" => "%{[log][responseTime]}"
        }
      }
    }

    # Parse trace IDs for distributed tracing correlation
    if [log][traceId] {
      mutate {
        add_field => { "trace_id" => "%{[log][traceId]}" }
      }
    }

    if [log][spanId] {
      mutate {
        add_field => { "span_id" => "%{[log][spanId]}" }
      }
    }
  }

  # Geoip enrichment for access logs
  if [client][ip] {
    geoip {
      source => "[client][ip]"
      target => "geoip"
    }
  }

  # User agent parsing
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "user_agent_parsed"
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "agrodeep-logs-%{+YYYY.MM.dd}"
    template_name => "agrodeep-logs"
    template_overwrite => true
  }

  # Send critical errors to a separate index for alerting
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "agrodeep-errors-%{+YYYY.MM.dd}"
    }
  }

  # Debug output (disable in production)
  # stdout { codec => rubydebug }
}
