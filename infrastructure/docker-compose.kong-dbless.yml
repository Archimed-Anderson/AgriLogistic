version: '3.9'

# ============================================================
# Kong API Gateway - DB-less Mode
# AgroLogistic 2.0 - Simplified Production-Ready Stack
# ============================================================

networks:
  agrologistic-network:
    external: true

volumes:
  kong-logs:
    name: agrologistic-kong-logs
  prometheus-data:
    name: agrologistic-prometheus-data
  grafana-data:
    name: agrologistic-grafana-data


services:
  # ============================================================
  # Kong Gateway (DB-less Mode)
  # ============================================================
  kong-gateway:
    image: kong:3.5
    container_name: kong-gateway
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      # DB-less Configuration
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      
      # Logging
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_LOG_LEVEL: info
      
      # Admin API
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_LISTEN: "off"

      # Status API (Prometheus `/metrics` is exposed here)
      KONG_STATUS_LISTEN: 0.0.0.0:8100
      
      # Proxy
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl http2
      
      # Plugins
      KONG_PLUGINS: bundled,jwt,rate-limiting,cors,request-transformer,response-transformer,prometheus,file-log,correlation-id,acl,ip-restriction,request-size-limiting,proxy-cache,zipkin
      
      # Performance
      KONG_NGINX_WORKER_PROCESSES: "auto"
      KONG_MEM_CACHE_SIZE: 128m
      KONG_NGINX_HTTP_CLIENT_BODY_BUFFER_SIZE: 10m
      KONG_NGINX_HTTP_CLIENT_MAX_BODY_SIZE: 10m
      
      # Security
      KONG_TRUSTED_IPS: 0.0.0.0/0,::/0
      KONG_REAL_IP_HEADER: X-Forwarded-For
      KONG_REAL_IP_RECURSIVE: "on"
    
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
      - kong-logs:/var/log/kong
    
    ports:
      - "8000:8000"   # Proxy HTTP
      - "8443:8443"   # Proxy HTTPS
      - "127.0.0.1:8001:8001"   # Admin API (localhost only)
      - "8100:8100"   # Status API /metrics
    
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ============================================================
  # Kong Deck - CLI Management Tool (Optional)
  # ============================================================
  # kong-deck:
  #   image: kong/deck:latest
  #   container_name: kong-deck
  #   networks:
  #     - agrologistic-network
  #   volumes:
  #     - ./kong:/kong
  #   entrypoint: /bin/sh
  #   command: -c "tail -f /dev/null"
  #   depends_on:
  #     kong-gateway:
  #       condition: service_healthy
  #   restart: unless-stopped

  # ============================================================
  # Prometheus (Optional - for monitoring)
  # ============================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: agrologistic-prometheus
    restart: unless-stopped
    networks:
      - agrologistic-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      - kong-gateway
    profiles:
      - monitoring

  # ============================================================
  # Grafana (Optional - for dashboards)
  # ============================================================
  grafana:
    image: grafana/grafana:latest
    container_name: agrologistic-grafana
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/prometheus.yml:ro
      - ./monitoring/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/kong.yml:ro
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
    profiles:
      - monitoring

  # ============================================================
  # Jaeger (Optional - tracing via Zipkin plugin)
  # ============================================================
  jaeger:
    image: jaegertracing/all-in-one:1.51
    container_name: agrologistic-jaeger
    restart: unless-stopped
    networks:
      - agrologistic-network
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
    ports:
      - "16686:16686"
      - "9411:9411"
    profiles:
      - tracing

