name: CI Pipeline - AgroLogistic Platform

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  CI: true
  NODE_VERSION: '18.x'
  PNPM_VERSION: '9.0.0'

jobs:
  validate-and-test:
    name: ğŸ›¡ï¸ Validate & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ”§ Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false

    - name: ğŸ§© Get pnpm store directory
      id: pnpm-cache
      run: |
        echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

    - name: ğŸ’¾ Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: ğŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ğŸ” Lint & Format Check
      run: |
        pnpm lint:quiet
        pnpm format:check

    - name: ğŸ—ï¸ Type Check (Build Validation)
      run: pnpm typecheck

    - name: ğŸ§ª Run Root Tests (Vitest)
      run: pnpm test:ci

    - name: ğŸ§ª Run Auth Service Tests (Jest)
      working-directory: services/identity/auth-service
      run: pnpm test

    - name: ğŸ§ª Run User Service Tests (Jest)
      working-directory: services/identity/user-service
      run: pnpm test

    - name: ğŸ—ï¸ Build All (Compilation Check)
      run: pnpm build:all
